stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE: "ocaml/opam:ubuntu-16.04_ocaml-4.05.0_flambda"

compile_and_test:
  stage: build
  tags:
    - shared
  image: $DOCKER_IMAGE
  script:
    - opam update
    - opam pin add zlist . -n
    - opam install zlist -t --deps-only
    - jbuilder build
    - jbuilder build @doc
    - jbuilder runtest
  artifacts:
    paths:
      - _build

pages:
  stage: deploy
  tags:
    - shared
  only:
    - master
  dependencies:
    - compile_and_test
  image: $DOCKER_IMAGE
  script:
    - mkdir public
    - cp -r _build/default/_doc/* public
  artifacts:
    paths:
      - public
